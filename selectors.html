<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=yes">
    <title>#listeningclub selector search</title>
</head>
<script>
    async function fetchSelectorsFromEntries() {
        const tsv = await fetch("./entries.tsv");
        const data = await tsv.text();
        const results = [];
        for(const row of data.split("\n")) {
            if(!row.length || row.startsWith("Date\t") || row.startsWith("-\t")) {
                continue;
            }
            const [date, selector, album] = row.split("\t");
            if (album.length < 2) {
                continue;
            }
            if (selector === "-" || selector.toLowerCase().startsWith("every") || selector === "VORTEX" || selector.toLowerCase().startsWith("holidays") || selector === "Closed") {
                continue;
            }
            results.push([selector.trim(), date]);
        }
        return results;
    }

    const aliases = {
        "@101retstum": "@mutster101",
        "@jimmmccauley": "@jimmccauley",
        "@jonny_pigg": "@jonnydapigg",
        "@ohmyliver": "@ogili",
        "@samquitter": "@samsmitter",
        "@wojsvenwoj": "@woj",
        "@xpollen8": "@david",
    }

    function formatInteger(num) {
        if(num.toLocaleString) {
            return num.toLocaleString();
        }
        return String(num);
    }

    function getCanonicalName(selectorNameVariants, selector) {
        const snv = selectorNameVariants.get(selector);
        let max = 0;
        let canonicalName = selector;
        for (const [name, count] of snv) {
            if (count > max) {
                max = count;
                canonicalName = name;
            }
        }
        return canonicalName;
    }

    async function loadData() {
        const selectors = new Map();
        const selectorNameVariants = new Map();
        const add = (selector, date) => {
            const selectorLower = selector.toLowerCase();
            if (!selectors.has(selectorLower)) {
                selectors.set(selectorLower, new Set());
                selectorNameVariants.set(selectorLower, new Map());
            }
            selectors.get(selectorLower).add(date);
            const thisSnv = selectorNameVariants.get(selectorLower);
            if(!thisSnv.has(selector)) {
                thisSnv.set(selector, 0);
            }
            thisSnv.set(selector, thisSnv.get(selector) + 1);
        };
        for (const [selector, date] of await fetchSelectorsFromEntries()) {
            add((aliases[selector.toLowerCase()] ?? selector).replaceAll("@", ""), date);
        }
        const selectorsByCanonicalName = new Map();
        // Map `selectors` by choosing the most popular variant as the canonical name
        for (const [selector, dates] of selectors) {
            selectorsByCanonicalName.set(getCanonicalName(selectorNameVariants, selector), dates);
        }
        return selectorsByCanonicalName;
    }

    let selectors = new Map();

    function update() {
        const sortOrder = document.querySelector("input[name=sort]:checked").value;
        const tbody = document.querySelector("#selectors tbody");
        tbody.innerHTML = "";
        const items = [];
        let totalN = 0;
        for (const [selector, dates] of selectors.entries()) {
            const datesSorted = Array.from(dates).sort();
            let lastDate = datesSorted[datesSorted.length - 1];
            let firstDate = datesSorted[0];
            let count = dates.size;
            const msSinceLast = Date.now() - new Date(lastDate);
            const daysSinceLast = Math.floor(msSinceLast / 1000 / 60 / 60 / 24);
            const weeksSinceLast = Math.floor(daysSinceLast / 7);

            const tr = document.createElement("tr");
            const nameTd = document.createElement("td");
            nameTd.textContent = selector;
            tr.appendChild(nameTd);

            const countTd = document.createElement("td");
            countTd.classList.add("count", "num");
            countTd.textContent = formatInteger(count);
            tr.appendChild(countTd);

            const daysSinceLastTd = document.createElement("td");
            daysSinceLastTd.classList.add("days", "num");
            daysSinceLastTd.textContent = formatInteger(daysSinceLast);
            tr.appendChild(daysSinceLastTd);

            const weeksSinceLastTd = document.createElement("td");
            weeksSinceLastTd.classList.add("weeks", "num");
            weeksSinceLastTd.textContent = formatInteger(weeksSinceLast);
            tr.appendChild(weeksSinceLastTd);

            Object.assign(tr.dataset, {lastDate, firstDate, daysSinceLast, count, selector});
            items.push(tr);
            totalN += count;
        }
        document.getElementById("outof").textContent = `out of ${formatInteger(totalN)}`;
        items.sort((a, b) => {
            if (sortOrder === "recency") {
                return a.dataset.daysSinceLast - b.dataset.daysSinceLast;
            } else {
                return b.dataset.count - a.dataset.count;
            }
        });
        for (const li of items) {
            tbody.appendChild(li);
        }
    }

	function compareValues(a, b) {
		// return -1/0/1 based on what you "know" a and b
		// are here. Numbers, text, some custom case-insensitive
		// and natural number ordering, etc. That's up to you.
		// A typical "do whatever JS would do" is:
		let A = a?.replace(/,/g,'');
		let B = b?.replace(/,/g,'');
		if (!isNaN(A) && !isNaN(B)) return A - B;
		return (A<B) ? -1 : (A>B) ? 1 : 0;
	}

	function sortTable(colnum) {
		// get all the rows in this table:
		const table = document.querySelector(`tbody`);
		const tbody = document.querySelector("#selectors tbody");
		let rows = Array.from(document.querySelectorAll(`tr`));

		// but ignore the heading row:
		//rows = rows.slice(1);

		// set up the queryselector for getting the indicated
		// column from a row, so we can compare using its value:
		let qs = `td:nth-child(${colnum})`;

		// and then just... sort the rows:
		rows.sort( (r1,r2) => {
			// get each row's relevant column
			let t1 = r1?.querySelector(qs);
			let t2 = r2?.querySelector(qs);

			// and then effect sorting by comparing their content:
			return compareValues(t1?.textContent,t2?.textContent);
		});

		// and then the magic part that makes the sorting appear on-page:
		rows.forEach(row => table.appendChild(row));
	}

    async function init() {
        selectors = await loadData();
        update();
    }
</script>
<style>
    * {
        box-sizing: border-box;
    }

    body {
        font-family: sans-serif;
        font-size: 12pt;
        line-height: 1.5;
    }

    main {
        max-width: 60em;
        margin: auto;
    }

    form {
        margin-bottom: 1em;
    }

    table {
        width: 100%;
        border-collapse: collapse;
    }

    td, th {
        border-bottom: #eee solid 1px;
        padding: 0.2em;
    }

    tr:hover td {
        background-color: #f8f8f8;
    }

    .num {
        text-align: right;
        font-variant: tabular-nums;
    }

		.sortable {
			cursor: pointer;
		}

    th {
        vertical-align: bottom;
        text-align: left;
    }

    #outof {
        display: block;
        font-size: 80%;
    }

    th span.s {
        display: block;
        font-size: 80%;
    }

</style>
<body onload="init()">
<main>
    <form onchange="update()" id="f">Sort by:
        <label><input type="radio" name="sort" value="recency" checked> Recency</label>
        <label><input type="radio" name="sort" value="count"> Count</label>
    </form>
    <table id="selectors">
        <thead>
        <tr>
            <th class="sortable" onclick="sortTable(1)">Selector</th>
            <th class="num sortable" onclick="sortTable(2)">Count <span id="outof"></span></th>
            <th class="num sortable" onclick="sortTable(3)">Days <span class="s">since last pick</span></th>
            <th class="num sortable" onclick="sortTable(4)">Weeks <span class="s">since last pick</span></th>
        </tr>
        </thead>
        <tbody></tbody>
    </table>
</main>
</body>
</html>
