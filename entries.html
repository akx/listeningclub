<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, user-scalable=yes" />
    <title>#listeningclub entries</title>
  </head>
  <script>
    async function fetchEntries() {
      const tsv = await fetch("./entries.tsv");
      const data = await tsv.text();
      const results = [];
      for (const row of data.split("\n")) {
        if (!row.trim().length) {
          continue;
        }
        const [date, selector, album, artist] = row.split("\t");
        if (date === "Date") continue;
        if (selector === "-") continue;
        results.push({ date, selector, album, artist });
      }
      return results;
    }

    let entries = [];

    function createRows() {
      const tbody = document.querySelector("#entries tbody");
      tbody.innerHTML = "";

      const filter = (document.getElementById("filter").value ?? "").toLowerCase().trim();

      let filteredEntries = entries;
      if (filter) {
        filteredEntries = entries.filter(
          (e) =>
            e.date?.toLowerCase().includes(filter) ||
            e.selector?.toLowerCase().includes(filter) ||
            e.album?.toLowerCase().includes(filter) ||
            e.artist?.toLowerCase().includes(filter),
        );
      }

      document.getElementById("info").textContent = `Showing ${filteredEntries.length} of ${entries.length} entries`;

      let lastYear = null;
      for (const entry of filteredEntries) {
        const tr = document.createElement("tr");
        const year = entry.date ? entry.date.split("-")[0] : null;
        if (lastYear && year !== lastYear) {
          tr.classList.add("new-year");
        }
        lastYear = year;

        tr.appendChild(
          Object.assign(document.createElement("td"), {
            textContent: entry.date || "",
            className: "date",
          }),
        );

        tr.appendChild(
          Object.assign(document.createElement("td"), {
            textContent: entry.selector || "",
          }),
        );

        tr.appendChild(
          Object.assign(document.createElement("td"), {
            textContent: entry.album || "",
          }),
        );

        tr.appendChild(
          Object.assign(document.createElement("td"), {
            textContent: entry.artist || "",
          }),
        );

        tbody.appendChild(tr);
      }
    }

    async function init() {
      entries = await fetchEntries();
      createRows();
    }
  </script>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: sans-serif;
      font-size: 12pt;
      line-height: 1.5;
    }

    main {
      max-width: 80em;
      margin: auto;
      padding: 1em;
    }

    input {
      width: 100%;
      padding: 1em;
      margin-bottom: 0.5em;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    td,
    th {
      border-bottom: #eee solid 1px;
      padding: 0.2em;
      text-align: left;
    }

    tr.new-year td {
      border-top: #ccc solid 2px;
    }

    th {
      background-color: #f8f8f8;
      font-weight: bold;
      position: sticky;
      top: 0;
      vertical-align: bottom;
    }

    tr:hover td {
      background-color: #f8f8f8;
    }

    .date {
      white-space: nowrap;
      font-variant: tabular-nums;
    }

    #info {
      margin: 0.5em 0;
      opacity: 0.6;
      font-size: 90%;
    }
  </style>
  <body onload="init()">
    <main>
      <h1>#listeningclub entries</h1>
      <input
        type="search"
        id="filter"
        placeholder="Filter by date, selector, album, or artist..."
        autofocus
        oninput="createRows()"
      />
      <p id="info"></p>
      <table id="entries">
        <thead>
          <tr>
            <th>Date</th>
            <th>Selector</th>
            <th>Album</th>
            <th>Artist</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </main>
  </body>
</html>
